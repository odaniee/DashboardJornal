{% extends 'base.html' %}
{% block content %}
<ul class="nav nav-tabs mb-3">
  {% for tab, label in dashboard_tabs %}
    <li class="nav-item">
      <a class="nav-link {% if current_tab == tab %}active{% endif %}" href="{{ url_for('dashboard', tab=tab) }}">{{ label }}</a>
    </li>
  {% endfor %}
</ul>

{% if current_tab == 'home' %}
  {% if widget_cards %}
    <div class="row g-3 mb-4">
      {% for widget in widget_cards %}
      <div class="col-sm-6 col-lg-3">
        <div class="card widget-card shadow-sm h-100">
          <div class="card-body">
            <p class="text-muted small mb-1">{{ widget.subtitle }}</p>
            <h3 class="h6 fw-bold">{{ widget.title }}</h3>
            {% if widget.type == 'metric' %}
              <div class="display-6 fw-semibold text-primary">{{ widget.value }}</div>
              <div class="small text-muted">{{ widget.helper }}</div>
            {% elif widget.type == 'event' %}
              <div class="fw-semibold">{{ widget.value }}</div>
              <div class="small text-muted">{{ widget.helper }}</div>
            {% else %}
              <div class="small text-muted">{{ widget.content or widget.helper }}</div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h5">Jornais e frequência</h2>
          {% if cadence_days %}
            <p class="mb-1 small text-muted">Frequência média de lançamento: {{ cadence_days }} dias</p>
          {% else %}
            <p class="mb-1 small text-muted">Cadastre pelo menos dois jornais para calcular a frequência.</p>
          {% endif %}
          <ul class="list-group list-group-flush mt-3">
            {% for journal in journals[:3] %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ journal.title }}</div>
                  <div class="small text-muted">{{ journal.edition }} · {{ journal.release_date }}</div>
                </div>
                <span class="badge bg-secondary">{{ journal.status }}</span>
              </li>
            {% else %}
              <li class="list-group-item text-muted">Sem jornais cadastrados.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h5">Calendário</h2>
          <ul class="list-group list-group-flush">
            {% for event in calendar_events %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ event.title }}</div>
                  <div class="small text-muted">{{ event.date }} · {{ event.description }}</div>
                </div>
                <span class="badge bg-light text-dark">{{ event.category }}</span>
              </li>
            {% else %}
              <li class="list-group-item text-muted">Nenhum evento no calendário.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
{% endif %}

{% if current_tab == 'students' %}
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="h5">Nova ficha</h2>
          <form method="post" action="{{ url_for('create_student') }}" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label" for="name">Nome</label>
              <input class="form-control" id="name" name="name" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="role">Função no jornal</label>
              <input class="form-control" id="role" name="role" placeholder="Repórter, editor, revisor...">
            </div>
            <div class="mb-3">
              <label class="form-label" for="department_id">Departamento</label>
              <select class="form-select" id="department_id" name="department_id">
                <option value="">Não vinculado</option>
                {% for department in departments %}
                  <option value="{{ department.id }}">{{ department.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="photo">Foto</label>
              <input class="form-control" type="file" id="photo" name="photo" accept="image/*">
            </div>
            <div class="mb-3">
              <label class="form-label" for="contact">Contato</label>
              <input class="form-control" id="contact" name="contact" placeholder="E-mail ou telefone">
            </div>
            <div class="mb-3">
              <label class="form-label" for="notes">Observações</label>
              <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="portal_enabled" name="portal_enabled" checked>
              <label class="form-check-label" for="portal_enabled">Habilitar acesso ao portal</label>
            </div>
            <div class="row mb-3">
              <div class="col-sm-6">
                <label class="form-label" for="portal_username">Usuário do portal</label>
                <input class="form-control" id="portal_username" name="portal_username" placeholder="login">
              </div>
              <div class="col-sm-6">
                <label class="form-label" for="portal_password">Senha inicial</label>
                <input class="form-control" type="password" id="portal_password" name="portal_password" placeholder="Defina uma senha">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="portal_role">Permissão</label>
              <select class="form-select" id="portal_role" name="portal_role">
                {% for role in roles %}
                  <option value="{{ role.name }}">{{ role.name }}</option>
                {% endfor %}
              </select>
            </div>
            <button class="btn btn-primary" type="submit">Salvar ficha</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5">Participantes cadastrados</h2>
          <div class="d-flex flex-wrap gap-3">
            {% for student in students %}
            <div class="card participant-card flex-grow-1">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="d-flex gap-3">
                    {% if student.photo %}
                      <img src="{{ url_for('employee_photo', filename=student.photo) }}" alt="Foto" class="rounded" style="width:64px; height:64px; object-fit:cover;">
                    {% endif %}
                    <div>
                    <h3 class="h6 mb-1">{{ student.name }}</h3>
                    <p class="mb-1 text-muted">{{ student.role or 'Função não informada' }}</p>
                    <p class="mb-1 small">{{ student.contact }}</p>
                    </div>
                  </div>
                  <span class="badge {% if student.portal_enabled %}bg-success{% else %}bg-secondary{% endif %}">
                    {% if student.portal_enabled %}Portal liberado{% else %}Portal bloqueado{% endif %}
                  </span>
                </div>
                <p class="mt-2 small">{{ student.notes or 'Sem observações' }}</p>
                <p class="small mb-2">Departamento: {{ departments|selectattr('id', 'equalto', student.department_id)|map(attribute='name')|first or 'Sem vínculo' }}</p>
                <div class="d-flex flex-wrap gap-2">
                  <form method="post" action="{{ url_for('toggle_student', student_id=student.id) }}">
                    <button class="btn btn-sm btn-outline-primary" type="submit">
                      {% if student.portal_enabled %}Bloquear{% else %}Liberar{% endif %}
                    </button>
                  </form>
                  <form method="post" action="{{ url_for('delete_student', student_id=student.id) }}" onsubmit="return confirm('Remover este funcionário?');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
                  </form>
                  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('print_student', student_id=student.id) }}" target="_blank">Imprimir ficha</a>
                </div>
                <details class="mt-3">
                  <summary class="small">Editar ficha e portal</summary>
                  <form class="mt-2" method="post" action="{{ url_for('update_student', student_id=student.id) }}">
                    <div class="row g-2">
                      <div class="col-md-6">
                        <label class="form-label small" for="name_{{ student.id }}">Nome</label>
                        <input class="form-control form-control-sm" id="name_{{ student.id }}" name="name" value="{{ student.name }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small" for="role_{{ student.id }}">Função</label>
                        <input class="form-control form-control-sm" id="role_{{ student.id }}" name="role" value="{{ student.role }}">
                      </div>
                    </div>
                    <div class="row g-2 mt-1">
                      <div class="col-md-6">
                        <label class="form-label small" for="contact_{{ student.id }}">Contato</label>
                        <input class="form-control form-control-sm" id="contact_{{ student.id }}" name="contact" value="{{ student.contact }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small" for="dept_{{ student.id }}">Departamento</label>
                        <select class="form-select form-select-sm" id="dept_{{ student.id }}" name="department_id">
                          <option value="" {% if not student.department_id %}selected{% endif %}>Sem vínculo</option>
                          {% for department in departments %}
                            <option value="{{ department.id }}" {% if department.id == student.department_id %}selected{% endif %}>{{ department.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                    <div class="mt-2">
                      <label class="form-label small" for="notes_{{ student.id }}">Observações</label>
                      <textarea class="form-control form-control-sm" id="notes_{{ student.id }}" name="notes" rows="2">{{ student.notes }}</textarea>
                    </div>
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" id="portal_enabled_{{ student.id }}" name="portal_enabled" {% if student.portal_enabled %}checked{% endif %}>
                      <label class="form-check-label small" for="portal_enabled_{{ student.id }}">Portal liberado</label>
                    </div>
                    <div class="row g-2 mt-1">
                      <div class="col-md-4">
                        <label class="form-label small" for="portal_username_{{ student.id }}">Usuário</label>
                        <input class="form-control form-control-sm" id="portal_username_{{ student.id }}" name="portal_username" value="{{ users|selectattr('id', 'equalto', student.user_id)|map(attribute='username')|first }}">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small" for="portal_password_{{ student.id }}">Nova senha</label>
                        <input class="form-control form-control-sm" type="password" id="portal_password_{{ student.id }}" name="portal_password" placeholder="Opcional">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small" for="portal_role_{{ student.id }}">Permissão</label>
                        <select class="form-select form-select-sm" id="portal_role_{{ student.id }}" name="portal_role">
                          {% set current_role = users|selectattr('id', 'equalto', student.user_id)|map(attribute='role')|first or 'Colaborador' %}
                          {% for role in roles %}
                            <option value="{{ role.name }}" {% if role.name == current_role %}selected{% endif %}>{{ role.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                    <div class="mt-2 d-flex justify-content-end">
                      <button class="btn btn-sm btn-primary" type="submit">Salvar alterações</button>
                    </div>
                  </form>
                </details>
              </div>
            </div>
            {% else %}
            <p class="text-muted">Nenhum participante cadastrado ainda.</p>
            {% endfor %}
            {% if students %}
              <div class="mt-3">
                <a class="btn btn-outline-secondary" target="_blank" href="{{ url_for('print_all_students') }}">Imprimir todos</a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

{% elif current_tab == 'journals' %}
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h5">Novo jornal</h2>
          <form method="post" action="{{ url_for('create_journal') }}" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label" for="title">Título</label>
              <input class="form-control" id="title" name="title" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="edition">Edição</label>
              <input class="form-control" id="edition" name="edition" placeholder="Ex: 25ª edição" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="release_date">Data de lançamento</label>
              <input class="form-control" type="date" id="release_date" name="release_date" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="description">Resumo</label>
              <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label" for="file">PDF do jornal (opcional)</label>
              <input class="form-control" type="file" id="file" name="file" accept="application/pdf">
            </div>
            <button class="btn btn-primary" type="submit">Enviar para aprovação</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5">Jornais</h2>
          <div class="list-group">
            {% for journal in journals %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h3 class="h6 mb-1">{{ journal.title }}</h3>
                  <p class="mb-1 text-muted">{{ journal.edition }} · Lançamento: {{ journal.release_date }}</p>
                  <p class="mb-2 small">{{ journal.description }}</p>
                  <div class="badge bg-info text-dark">Status: {{ journal.status }}</div>
                  {% if journal.approval_reason %}
                    <div class="small text-danger">Motivo: {{ journal.approval_reason }}</div>
                  {% endif %}
                  <div class="mt-2">
                    <span class="small fw-semibold">Link de aprovação:</span>
                    <code class="d-block text-break">{{ base_url }}{{ url_for('approve_journal', token=journal.approval_token) }}</code>
                  </div>
                </div>
                <div class="ms-3 text-end">
                  {% if journal.file %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_journal', filename=journal.file) }}">PDF</a>
                  {% endif %}
                  <span class="badge bg-secondary ms-2">Criado em {{ journal.created_at[:10] }}</span>
                  <form class="mt-2" method="post" action="{{ url_for('delete_journal', journal_id=journal.id) }}" onsubmit="return confirm('Excluir este jornal?');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
                  </form>
                </div>
              </div>
            </div>
            {% else %}
            <p class="text-muted">Nenhum jornal cadastrado.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

{% elif current_tab == 'assets' %}
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h5">Enviar arquivo</h2>
          <form method="post" action="{{ url_for('upload_asset') }}" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label" for="file">Arquivo</label>
              <input class="form-control" type="file" id="file" name="file" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="owner">Responsável</label>
              <input class="form-control" id="owner" name="owner" placeholder="Nome do responsável (opcional)">
            </div>
            <div class="mb-3">
              <label class="form-label" for="department_id">Direcionar para departamento (opcional)</label>
              <select class="form-select" id="department_id" name="department_id">
                <option value="">Pasta pessoal</option>
                {% for dept in departments %}
                  <option value="{{ dept.id }}">{{ dept.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="notes">Notas de uso</label>
              <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" type="submit">Guardar</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h6 text-uppercase text-muted">Arquivos de departamentos</h2>
          <div class="list-group">
            {% for asset in assets if asset.scope == 'departamento' %}
            <div class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold">{{ asset.original_name }}</div>
                <div class="small text-muted">{{ asset.uploaded_at[:10] }} · {{ asset.notes or 'Sem notas' }}</div>
                <div class="small">Departamento: {{ (departments | selectattr('id','equalto', asset.department_id) | first).name if asset.department_id else '—' }}</div>
              </div>
              <div class="d-flex flex-column gap-2 align-items-end">
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_asset', filename=asset.stored_name) }}">Baixar</a>
                <form method="post" action="{{ url_for('delete_asset', asset_id=asset.id) }}" onsubmit="return confirm('Remover este arquivo?');">
                  <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
                </form>
              </div>
            </div>
            {% else %}
            <p class="text-muted">Nenhum arquivo departamental.</p>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6 text-uppercase text-muted">Pasta pessoal e geral</h2>
          <div class="list-group">
            {% for asset in assets if asset.scope != 'departamento' %}
            <div class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold">{{ asset.original_name }}</div>
                <div class="small text-muted">{{ asset.uploaded_at[:10] }}</div>
                <div class="small">{{ asset.notes }}</div>
              </div>
              <div class="d-flex flex-column gap-2 align-items-end">
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_asset', filename=asset.stored_name) }}">Baixar</a>
                <form method="post" action="{{ url_for('delete_asset', asset_id=asset.id) }}" onsubmit="return confirm('Remover este arquivo?');">
                  <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
                </form>
              </div>
            </div>
            {% else %}
            <p class="text-muted">Nenhum arquivo enviado.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

{% elif current_tab == 'rules' %}
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5">Manual de regras</h2>
          <form method="post" action="{{ url_for('update_rules') }}">
            <div class="mb-3">
              <label class="form-label" for="rules-content">Conteúdo</label>
              <textarea class="form-control" id="rules-content" name="content" rows="12">{{ rules.content }}</textarea>
            </div>
            <button class="btn btn-primary" type="submit">Salvar manual</button>
            {% if rules.updated_at %}
              <span class="small text-muted ms-2">Atualizado em {{ rules.updated_at[:16] }}</span>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h6">Dicas de uso</h2>
          <p class="small">Use este espaço para documentar boas práticas, limites de páginas, regras de crédito e padrões de revisão. O texto é salvo imediatamente para todos os administradores.</p>
        </div>
      </div>
    </div>
  </div>

{% elif current_tab == 'announcements' %}
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h5">Nova mensagem</h2>
          <form method="post" action="{{ url_for('create_announcement') }}">
            <div class="mb-3">
              <label class="form-label" for="title">Título</label>
              <input class="form-control" id="title" name="title" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="body">Mensagem</label>
              <textarea class="form-control" id="body" name="body" rows="4" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label" for="audience">Destinatário</label>
              <select class="form-select" id="audience" name="audience">
                <option value="todos">Todos do jornal</option>
                <option value="diretores">Diretores de departamento</option>
                <option value="staff">Equipe administrativa</option>
              </select>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="pinned" name="pinned">
              <label class="form-check-label" for="pinned">Fixar no topo</label>
            </div>
            <button class="btn btn-primary" type="submit">Publicar</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5">Canal de administração</h2>
          <div class="list-group">
            {% for announcement in announcements %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="d-flex align-items-center gap-2">
                    {% if announcement.pinned %}<span class="badge bg-warning text-dark">Fixado</span>{% endif %}
                    <h3 class="h6 mb-0">{{ announcement.title }}</h3>
                  </div>
                  <div class="small text-muted">{{ announcement.created_at[:16] }} · {{ announcement.audience|capitalize }}</div>
                  <p class="mb-1">{{ announcement.body }}</p>
                </div>
                <form method="post" action="{{ url_for('remove_announcement', announcement_id=announcement.id) }}">
                  <button class="btn btn-sm btn-outline-danger" type="submit">Remover</button>
                </form>
              </div>
            </div>
            {% else %}
            <p class="text-muted">Nenhuma mensagem publicada.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

{% elif current_tab == 'calendar' %}
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h5">Novo evento</h2>
          <form method="post" action="{{ url_for('add_calendar_event') }}">
            <div class="mb-3">
              <label class="form-label" for="title">Título</label>
              <input class="form-control" id="title" name="title" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="date">Data e hora</label>
              <input class="form-control" type="datetime-local" id="date" name="date" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="category">Categoria</label>
              <select class="form-select" id="category" name="category">
                <option value="geral">Geral</option>
                <option value="departamento">Departamento</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="department_id">Departamento (opcional)</label>
              <select class="form-select" id="department_id" name="department_id">
                <option value="">Não vincular</option>
                {% for dept in departments %}
                  <option value="{{ dept.id }}">{{ dept.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="description">Descrição</label>
              <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" type="submit">Adicionar</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h6 text-uppercase text-muted">Calendário geral</h2>
          <ul class="list-group list-group-flush">
            {% for event in calendar_events if event.category != 'departamento' %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ event.title }}</div>
                  <div class="small text-muted">{{ event.date }}</div>
                  <div class="small">{{ event.description }}</div>
                </div>
                <form method="post" action="{{ url_for('delete_calendar_event', event_id=event.id) }}" onsubmit="return confirm('Excluir este evento?');">
                  <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
                </form>
              </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">Sem eventos gerais.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6 text-uppercase text-muted">Calendário de departamentos</h2>
          <ul class="list-group list-group-flush">
            {% for event in calendar_events if event.category == 'departamento' %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ event.title }}</div>
                  <div class="small text-muted">{{ event.date }} · {{ (departments | selectattr('id','equalto', event.department_id) | first).name if event.department_id else 'Sem dept.' }}</div>
                  <div class="small">{{ event.description }}</div>
                </div>
                <form method="post" action="{{ url_for('delete_calendar_event', event_id=event.id) }}" onsubmit="return confirm('Excluir este evento?');">
                  <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
                </form>
              </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">Sem eventos departamentais.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

{% elif current_tab == 'departments' %}
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h5">Novo departamento</h2>
          <form method="post" action="{{ url_for('create_department') }}">
            <div class="mb-3">
              <label class="form-label" for="name">Nome</label>
              <input class="form-control" id="name" name="name" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="director">Diretor</label>
              <input class="form-control" id="director" name="director" placeholder="Responsável pela aprovação" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="description">Descrição</label>
              <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" type="submit">Criar</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5">Departamentos ativos</h2>
          <div class="list-group">
            {% for dept in departments %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ dept.name }}</div>
                  <div class="small text-muted">Diretor: {{ dept.director }}</div>
                  <div class="small">{{ dept.description }}</div>
                  <div class="mt-2 small">
                    Link de inscrição:
                    <code class="d-block text-break">{{ base_url }}{{ url_for('apply_department', token=dept.join_token) }}</code>
                  </div>
                </div>
                <div class="text-end">
                  <div class="badge bg-secondary">{{ dept.members|length }} membro(s)</div>
                </div>
              </div>
              <div class="row mt-3 g-3">
                <div class="col-md-6">
                  <h3 class="h6">Fila de espera</h3>
                  <ul class="list-group list-group-flush">
                    {% for req in dept.queue %}
                      <li class="list-group-item">
                        <div class="fw-semibold">{{ req.name }}</div>
                        <div class="small text-muted">{{ req.contact }} · {{ req.created_at[:16] }}</div>
                        <div class="small">Deseja: {{ req.desired_role }} — {{ req.motivation }}</div>
                        <div class="d-flex gap-2 mt-2">
                          {% if req.status == 'pendente' %}
                          <form method="post" action="{{ url_for('decide_queue', department_id=dept.id, queue_id=req.id, action='approve') }}">
                            <button class="btn btn-sm btn-success" type="submit">Aprovar</button>
                          </form>
                          <form method="post" action="{{ url_for('decide_queue', department_id=dept.id, queue_id=req.id, action='reject') }}">
                            <button class="btn btn-sm btn-outline-danger" type="submit">Recusar</button>
                          </form>
                          {% else %}
                          <span class="badge bg-info">{{ req.status|capitalize }}</span>
                          {% endif %}
                        </div>
                      </li>
                    {% else %}
                      <li class="list-group-item text-muted">Ninguém aguardando.</li>
                    {% endfor %}
                  </ul>
                </div>
                <div class="col-md-6">
                  <h3 class="h6">Equipe</h3>
                  <ul class="list-group list-group-flush">
                    {% for member in dept.members %}
                      <li class="list-group-item">
                        <div class="fw-semibold">{{ member.name }}</div>
                        <div class="small text-muted">{{ member.role or 'Função não informada' }} · {{ member.joined_at[:10] }}</div>
                      </li>
                    {% else %}
                      <li class="list-group-item text-muted">Nenhum membro ainda.</li>
                    {% endfor %}
                  </ul>
                  <form class="mt-2" method="post" action="{{ url_for('add_member', department_id=dept.id) }}">
                    <div class="input-group input-group-sm">
                      <input class="form-control" name="name" placeholder="Nome" required>
                      <input class="form-control" name="role" placeholder="Função">
                      <button class="btn btn-outline-primary" type="submit">Adicionar</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            {% else %}
            <p class="text-muted">Nenhum departamento configurado.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

{% elif current_tab == 'tickets' %}
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h5">Abrir ticket para a diretoria</h2>
          <form method="post" action="{{ url_for('create_ticket') }}">
            <div class="mb-3">
              <label class="form-label" for="title">Título</label>
              <input class="form-control" id="title" name="title" placeholder="Ex.: Preciso de aprovação" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="reason">Motivo</label>
              <select class="form-select" id="reason" name="reason" required>
                {% for reason in reasons %}
                  <option value="{{ reason }}">{{ reason }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="custom_reason">Outro motivo (se precisar)</label>
              <input class="form-control" id="custom_reason" name="custom_reason" placeholder="Descreva outro motivo">
            </div>
            <div class="mb-3">
              <label class="form-label" for="urgency">Urgência</label>
              <select class="form-select" id="urgency" name="urgency">
                <option value="baixa">Baixa</option>
                <option value="normal" selected>Normal</option>
                <option value="alta">Alta</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="message">Descrição inicial</label>
              <textarea class="form-control" id="message" name="message" rows="3" required></textarea>
            </div>
            <button class="btn btn-primary" type="submit">Criar ticket</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h5 mb-0">Tickets recentes</h2>
            {% if current_user.permissions and 'manage_tickets' in current_user.permissions %}
              <span class="badge bg-primary">Visão de diretoria</span>
            {% endif %}
          </div>
          <div class="list-group list-group-flush">
            {% for ticket in tickets %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ ticket.title }}</div>
                  <div class="small text-muted">Motivo: {{ ticket.reason }} · Aberto por {{ ticket.created_by }} ({{ ticket.created_role or 'Cargo não informado' }})</div>
                  <div class="small">Urgência: {{ ticket.urgency|capitalize }} · Status: {{ ticket.status|capitalize }}</div>
                </div>
                <div class="d-flex gap-2">
                  {% if 'manage_tickets' in current_user.permissions %}
                  <form method="post" action="{{ url_for('close_ticket', ticket_id=ticket.id) }}">
                    <input type="hidden" name="message" value="Ticket encerrado pela diretoria">
                    <button class="btn btn-sm btn-outline-success" type="submit" {% if ticket.status == 'fechado' %}disabled{% endif %}>Fechar</button>
                  </form>
                  <form method="post" action="{{ url_for('delete_ticket', ticket_id=ticket.id) }}" onclick="return confirm('Remover este ticket?')">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Apagar</button>
                  </form>
                  {% endif %}
                </div>
              </div>
              <div class="mt-3 bg-light rounded p-3">
                <div class="small text-muted mb-2">Conversa</div>
                <ul class="list-unstyled mb-3 conversation-list">
                  {% for msg in ticket.messages %}
                  <li class="mb-2">
                    <div class="fw-semibold">{{ msg.author }} <span class="text-muted small">{{ msg.timestamp[:16] }}</span></div>
                    <div class="small text-muted">{{ msg.role or 'Sem cargo' }}</div>
                    <div>{{ msg.body }}</div>
                  </li>
                  {% endfor %}
                </ul>
                <form method="post" action="{{ url_for('reply_ticket', ticket_id=ticket.id) }}" class="d-flex gap-2">
                  <input class="form-control" name="message" placeholder="Responder" required>
                  <button class="btn btn-outline-primary" type="submit">Enviar</button>
                </form>
              </div>
            </div>
            {% else %}
            <p class="text-muted">Nenhum ticket registrado ainda.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

{% elif current_tab == 'settings' %}
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h5">Widgets do dashboard</h2>
          <form method="post" action="{{ url_for('update_dashboard_widgets') }}">
            {% for widget in widget_config %}
            <div class="border rounded p-3 mb-2">
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="enabled_{{ widget.id }}" name="enabled_{{ widget.id }}" {% if widget.enabled %}checked{% endif %}>
                <label class="form-check-label" for="enabled_{{ widget.id }}">{{ widget.title }}</label>
              </div>
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small" for="title_{{ widget.id }}">Título</label>
                  <input class="form-control form-control-sm" id="title_{{ widget.id }}" name="title_{{ widget.id }}" value="{{ widget.title }}">
                </div>
                <div class="col-6">
                  <label class="form-label small" for="subtitle_{{ widget.id }}">Subtítulo</label>
                  <input class="form-control form-control-sm" id="subtitle_{{ widget.id }}" name="subtitle_{{ widget.id }}" value="{{ widget.subtitle }}">
                </div>
              </div>
              <p class="small text-muted mt-2 mb-0">Tipo: {{ widget.type }}</p>
            </div>
            {% endfor %}
            <button class="btn btn-primary mt-2" type="submit">Salvar widgets</button>
          </form>
        </div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h5">Configurações visuais</h2>
          <form method="post" action="{{ url_for('update_settings') }}" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label" for="logo_file">Logo (upload)</label>
              <input class="form-control" type="file" id="logo_file" name="logo_file" accept="image/*">
              <p class="form-text">Imagens PNG ou JPG. Você também pode informar um URL opcional abaixo.</p>
            </div>
            <div class="mb-3">
              <label class="form-label" for="logo_url">Logo (URL)</label>
              <input class="form-control" id="logo_url" name="logo_url" value="{{ site_settings.logo_url }}" placeholder="https://...">
            </div>
            <div class="mb-3">
              <label class="form-label" for="tagline">Mensagem do topo</label>
              <input class="form-control" id="tagline" name="tagline" value="{{ site_settings.tagline }}" maxlength="80">
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="primary_color">Cor principal</label>
                <input class="form-control form-control-color" type="color" id="primary_color" name="primary_color" value="{{ site_settings.primary_color }}" title="Selecione a cor primária">
              </div>
              <div class="col-md-6">
                <label class="form-label" for="accent_color">Cor de destaque</label>
                <input class="form-control form-control-color" type="color" id="accent_color" name="accent_color" value="{{ site_settings.accent_color }}" title="Selecione a cor de destaque">
              </div>
            </div>
            <button class="btn btn-primary mt-3" type="submit">Salvar tema</button>
          </form>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6 text-uppercase text-muted">Governança rápida</h2>
          <p class="small mb-2">Promova alguém para Administrador, Gerente ou Diretor de Departamento.</p>
          <div class="list-group">
            {% for user in users %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ user.name }}</div>
                  <div class="small text-muted">{{ user.username }} · {{ user.role }}</div>
                </div>
                <span class="badge {{ user.portal_enabled and 'bg-success' or 'bg-secondary' }}">{{ user.portal_enabled and 'Ativo' or 'Bloqueado' }}</span>
              </div>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <form method="post" action="{{ url_for('update_user_role', user_id=user.id) }}" class="d-flex gap-2 align-items-center">
                  <select class="form-select form-select-sm" name="role">
                    {% for role in roles %}
                    <option value="{{ role.name }}" {% if role.name == user.role %}selected{% endif %}>{{ role.name }}</option>
                    {% endfor %}
                  </select>
                  <input type="hidden" name="redirect_to" value="{{ url_for('dashboard', tab='settings') }}">
                  <button class="btn btn-sm btn-outline-primary" type="submit">Aplicar</button>
                </form>
                <form method="post" action="{{ url_for('toggle_user_access', user_id=user.id) }}">
                  <input type="hidden" name="redirect_to" value="{{ url_for('dashboard', tab='settings') }}">
                  <button class="btn btn-sm btn-outline-secondary" type="submit">{{ user.portal_enabled and 'Bloquear' or 'Liberar' }}</button>
                </form>
              </div>
              <details class="mt-2">
                <summary class="small">Editar login e senha</summary>
                <form class="mt-2 d-grid gap-2" method="post" action="{{ url_for('update_user', user_id=user.id) }}">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label small" for="user_name_{{ user.id }}">Nome</label>
                      <input class="form-control form-control-sm" id="user_name_{{ user.id }}" name="name" value="{{ user.name }}">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small" for="user_username_{{ user.id }}">Usuário</label>
                      <input class="form-control form-control-sm" id="user_username_{{ user.id }}" name="username" value="{{ user.username }}">
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label small" for="user_role_{{ user.id }}">Cargo</label>
                      <select class="form-select form-select-sm" id="user_role_{{ user.id }}" name="role">
                        {% for role in roles %}
                          <option value="{{ role.name }}" {% if role.name == user.role %}selected{% endif %}>{{ role.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small" for="user_password_{{ user.id }}">Nova senha</label>
                      <input class="form-control form-control-sm" type="password" id="user_password_{{ user.id }}" name="password" placeholder="Opcional">
                    </div>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="portal_enabled_user_{{ user.id }}" name="portal_enabled" {% if user.portal_enabled %}checked{% endif %}>
                    <label class="form-check-label small" for="portal_enabled_user_{{ user.id }}">Portal liberado</label>
                  </div>
                  <div class="d-flex gap-2 justify-content-end">
                    <button class="btn btn-sm btn-primary" type="submit">Salvar</button>
                    <a class="btn btn-sm btn-outline-danger" href="#" onclick="if(confirm('Remover este usuário?')) { document.getElementById('delete-user-{{ user.id }}').submit(); } return false;">Excluir</a>
                  </div>
                </form>
                <form id="delete-user-{{ user.id }}" method="post" action="{{ url_for('delete_user', user_id=user.id) }}"></form>
              </details>
            </div>
            {% else %}
            <p class="text-muted mb-0">Nenhum usuário cadastrado ainda.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h5">Novo usuário com acesso</h2>
          <form method="post" action="{{ url_for('create_user') }}">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="name">Nome</label>
                <input class="form-control" id="name" name="name" required>
              </div>
              <div class="col-md-3">
                <label class="form-label" for="username">Usuário</label>
                <input class="form-control" id="username" name="username" required>
              </div>
              <div class="col-md-3">
                <label class="form-label" for="password">Senha</label>
                <input class="form-control" id="password" name="password" type="password" required>
              </div>
            </div>
            <div class="row g-3 mt-1">
              <div class="col-md-6">
                <label class="form-label" for="role">Cargo</label>
                <select class="form-select" id="role" name="role">
                  {% for role in roles %}
                  <option value="{{ role.name }}">{{ role.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="portal_enabled" name="portal_enabled" checked>
                  <label class="form-check-label" for="portal_enabled">Permitir acesso imediato</label>
                </div>
              </div>
            </div>
            <input type="hidden" name="redirect_to" value="{{ url_for('dashboard', tab='settings') }}">
            <button class="btn btn-primary mt-3" type="submit">Criar usuário</button>
          </form>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5">Novo cargo com permissões</h2>
          <form method="post" action="{{ url_for('create_role') }}">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label" for="role-name-dashboard">Nome</label>
                <input class="form-control" id="role-name-dashboard" name="name" required>
              </div>
              <div class="col-md-8">
                <label class="form-label" for="role-desc-dashboard">Descrição</label>
                <input class="form-control" id="role-desc-dashboard" name="description" required>
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Permissões</label>
              <div class="row row-cols-2 row-cols-md-3 g-2">
                {% for perm in all_permissions %}
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="{{ perm }}" id="role-perm-{{ loop.index }}" name="permissions">
                    <label class="form-check-label small" for="role-perm-{{ loop.index }}">{{ perm }}</label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            <input type="hidden" name="redirect_to" value="{{ url_for('dashboard', tab='settings') }}">
            <button class="btn btn-primary mt-3" type="submit">Salvar cargo</button>
          </form>
          <div class="mt-3 small text-muted">
            Sugestões: promova quem lidera times de conteúdo para "Diretor de Departamento" e mantenha apenas a coordenação pedagógica como "Administrador".
          </div>
        </div>
      </div>
    </div>
  </div>

{% elif current_tab == 'versions' %}
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h5">Linha do tempo de versões</h2>
      <div class="timeline">
        {% for journal in journals %}
        <div class="timeline-item">
          <div class="timeline-date">{{ journal.release_date }}</div>
          <div class="timeline-content">
            <div class="fw-semibold">{{ journal.edition }} — {{ journal.title }}</div>
            <div class="small text-muted">Status: {{ journal.status }}</div>
            {% if journal.approval_reason %}
              <div class="small text-danger">Motivo: {{ journal.approval_reason }}</div>
            {% endif %}
          </div>
        </div>
        {% else %}
        <p class="text-muted">Ainda não há edições cadastradas.</p>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}
